<!doctype html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
        <script src="/cryptojs/core.js"></script>
        <script src="/cryptojs/enc-base64.js"></script>
        <script src="/cryptojs/evpkdf.js"></script>
        <script src="/cryptojs/hmac.js"></script>
        <script src="/cryptojs/pbkdf2.js"></script>
        <script src="/cryptojs/cipher-core.js"></script>
        <script src="/cryptojs/aes.js"></script>
        <script src="/cryptojs/x64-core.js"></script>
        <script src="/cryptojs/sha512.js"></script>
        <script src="/cryptojs/opensslpbkdf2.js"></script>

        <title>paste.sh &middot; {{encrypted}} pastebin</title>
        <script>

            var content = '{{content}}';
            var editable = '{{editable}}';
            var serverkey = {{serverkey}};
            var ptype = '{{type}}';

            var cmd = false;

            var paste = {
              shouldSave: false,
              saveTimer: null,
              text: "",
              subject: "",
            };

            onload = function() {
              var textarea = document.getElementById('x');
              var subjectArea = document.getElementById('s');
              // Ensure the element remains focused (little hacky, but easier than
              // implementing selection blocking, key capture, etc).
              textarea.onblur = function() {
                if(cmd) {
                  maybeSave();
                }
              }
              textarea.onfocus = function() {
                cmd = false;
              }

              if (serverkey && content.length > 0) {
                try {
                  let text = decrypt(getKey(), content);
                  if (ptype == 'v3') {
                    let endHeader = text.indexOf("\n\n");
                    let header = text.slice(0, endHeader);
                    let subject = header.match(/^Subject:\s*(.*)/m);
                    if (subject) {
                      paste.subject = document.getElementById('s').innerText = subject[1];
                    }
                    text = text.slice(endHeader + 2);
                  }
                  paste.text = textarea.value = text;
                } catch(e) {
                  textarea.value = "Decryption failed (" + e + ")";
                  editable = false;
                }
              }
              textarea.focus();
              textarea.selectionStart = 0;
              textarea.selectionEnd = 0;
              textarea.scrollTo(0, 0);

              if(!editable) {
                textarea.setAttribute('readonly', true);
                textarea.setAttribute('spellcheck', false);
                textarea.ondblclick = function() {
                  if(confirm("You can't edit this paste, would you like to create a copy? You'll need to share the new URL.")) {
                    generate();
                    textarea.removeAttribute('readonly');
                    textarea.removeAttribute('spellcheck');
                    textarea.ondblclick = null;
                    editable = true;
                  }
                }
              }

              textarea.onmousedown = function(e) {
                if(!editable) return;
                // Middle click paste
                if(e.button == 1 && !serverkey) {
                  textarea.value = '';
                }
              }

              // Note the content changed and we should save this.
              textarea.onchange = shouldSave;
              textarea.oninput = shouldSave;
              subjectArea.addEventListener("input", shouldSave);

              subjectArea.addEventListener("keydown", function(e) {
                if (e.key == 'Enter') {
                  e.preventDefault();
                  textarea.focus();
                }
              });

              subjectArea.addEventListener("paste", e => {
                e.preventDefault();
                let paste = (e.clipboardData || window.clipboardData).getData("text");
                paste = paste.replace(/\n/g, "");
                const selection = window.getSelection();
                if (!selection.rangeCount) return;
                selection.deleteFromDocument();
                selection.getRangeAt(0).insertNode(document.createTextNode(paste));
                selection.collapseToEnd();
              });

              var seen_esc = false;
              textarea.onkeydown = function(e) {
                if(seen_esc && e.shiftKey && e.keyCode == 186 /* : */) {
                  e.preventDefault();
                  return;
                  // TODO: finish Vim command support.
                  // :set spell/nospell; number maybe;
                  // :w[rite], :e[dit], :raw.
                  document.getElementById('command').style.display = 'block';
                  document.getElementById('cmd').value = ':';
                  setTimeout(function() { document.getElementById('cmd').focus() }, 1);
                  sene_esc = false;
                  cmd = true;
                }
                if(e.keyCode == 27 && !e.altKey && !e.metaKey && !e.ctrlKey && !e.shiftKey) {
                  seen_esc = true;
                  e.preventDefault();
                  return;
                } else if(e.keyCode >= 32) {
                  seen_esc = false;
                }

                if(!editable) return;
                if(!e.ctrlKey && !e.altKey && !e.metaKey) {
                  shouldSave();
                }
                // Make tab key work, keep shift+tab as a method to get to the URL bar.
                if(e.keyCode == 9 && !seen_esc && !e.shiftKey && !e.ctrlKey) {
                  e.preventDefault();
                  var s = this.selectionStart;
                  this.value = this.value.substring(0, this.selectionStart) + "\t" +
                    this.value.substring(this.selectionEnd);
                  this.selectionEnd = s + 1;
                } else if (e.keyCode == 9) {
                  cmd = true;
                }
              }
              // Ensure typing and ctrl-a works even if the textarea wasn't focused
              window.onkeydown = function(e) {
                if (e.ctrlKey || e.keyCode >= 32) {
                  if (e.target.id != "s" && e.target.id != "x") {
                    textarea.focus();
                  }
                }
              }

              // If the document loses focus save right away (the idea being this is likely
              // someone selecting the URL to share).
              window.onblur = maybeSave;
              window.onresize = maybeSave;
              textarea.onmouseout = maybeSave;

              window.onbeforeunload = function() {
                if(paste.shouldSave) {
                  maybeSave();
                  return "Data is still being saved. You may lose data if you leave the page now.";
                }
                return null;
              }
            }

            function getKey() {
              var hash = location.hash.substr(1);
              // Allow empty keys on special URLs like /about and public pastes (/p.{8}) but not encrypted ones.
              if(hash.length < 18 && (location.pathname.length == 8 ||
                    (location.pathname.length > 8 && location.pathname[1] != 'p'))) {
                throw "Invalid hash, ensure you have the full URL, including the full '#xxxx' part at the end";
              }
              return location.pathname.substr(1) + serverkey + hash + 'https://paste.sh';
            }

            function maybeSave() {
              if(paste.shouldSave) {
                document.getElementById('status').textContent = 'Saving...';
                try {
                  // This keeps the key unique per save
                  serverkey = serverkey.substr(0, 8) + randomStr(6);
                  // Always upgrade to v3 on save
                  let version = 3;
                  serverSave(location.pathname, encrypt(getKey(), version), version);
                } catch(e) {
                  alert(e);
                }
              }
            }

            function serverSave(path, content, version) {
              var xhr = new XMLHttpRequest;
              xhr.open("PUT", path, true);
              xhr.setRequestHeader('X-Server-Key', serverkey);
              xhr.setRequestHeader('Content-Type',
                version == 3 ? 'text/vnd.paste.sh-v3' :
                version == 2 ? 'text/vnd.paste.sh-v2' :'text/plain');
              xhr.onreadystatechange = function() {
                if(this.readyState == this.DONE) {
                  // XXX: check status
                  paste.shouldSave = false;
                  document.getElementById('status').textContent = this.responseText;
                }
              }
              xhr.send(content);
            }

            function getServerKey() {
              var xhr = new XMLHttpRequest;
              xhr.open("GET", '/new?id=' + location.pathname.substr(1), true);
              xhr.onreadystatechange = function() {
                if(this.readyState == this.DONE) {
                  serverkey = this.responseText;
                }
              }
              xhr.send();
            }


            // TODO: Not hooked up yet
            function updateCursorPos() {
              var lines = this.value.substring(0, this.selectionStart).split("\n");
              var line = lines.length;
              var col = lines[lines.length - 1].length;
              return "" + line + "," + col;
            }

            var oldwarning = false;

            function shouldSave() {
              if(!editable) return;
              if(!('crypto' in window) || !('getRandomValues' in window.crypto)) {
                if(!oldwarning) {
                  alert('This browser does not have crypto.getRandomValues. To securely create pastes please upgrade to a recent version of Chrome or Firefox');
                  oldwarning = true;
                }
                document.getElementById('x').disabled = true;
                return;
              }
              if(location.pathname == '/') {
                generate();
              }

              var textarea = document.getElementById('x');
              var subjectArea = document.getElementById('s');
              if(paste.text != textarea.value || paste.subject != subjectArea.innerText) {
                paste.shouldSave = true;
                paste.text = textarea.value;
                paste.subject = subjectArea.innerText;
                document.getElementById('status').textContent = 'Unsaved 💾';
                if (paste.saveTimer)
                  clearTimeout(paste.saveTimer);
                paste.saveTimer = setTimeout(maybeSave, 4000);
              }
            }

            function randomStr(n) {
              return  CryptoJS.lib.WordArray.random(n).toString(
                  CryptoJS.enc.Base64).replace(/[\+\/]/g, function(x) { return x == '+' ? '-' : '_'});
            }

            function generate() {
              if(!document.cookie.match(/pasteauth=/)) {
                document.cookie = 'pasteauth=' + randomStr(18);
              }
              var r = randomStr(6);
              var clientkey = randomStr(18);
              history.replaceState(null, '', '/' + r + (clientkey ? '#' + clientkey : ''));
              getServerKey(); // XXX: racy
            }

            function encrypt(password, version) {
              message = document.getElementById('x').value;
              if (version == 3) {
                message = "Subject: " + document.getElementById('s').innerText.replace(/\n/g, "") + "\n\n" +
                  message;
              }

              var e;
              if (version == 1) {
                // This matches "openssl enc -aes-256-cbc -md sha512"
                e = CryptoJS.lib.PasswordBasedCipher.encrypt(
                  CryptoJS.algo.AES, message, password,
                  { hasher: CryptoJS.algo.SHA512 });
              } else {
                // This matches "openssl enc -aes-256-cbc -md sha512 -iter 1" (PBKF2)
                let kdf = OpenSSLPbkdf2;
                e = CryptoJS.lib.PasswordBasedCipher.encrypt(
                  CryptoJS.algo.AES, message, password,
                  { kdf: kdf, hasher: CryptoJS.algo.SHA512 });
              }
              return e.toString();
            }

            function decrypt(password, message) {
              var e;
              let version = ptype == 'v2' || ptype == 'v3' ? 2 : 1;
              if (version == 1) {
                e = CryptoJS.lib.PasswordBasedCipher.decrypt(
                    CryptoJS.algo.AES, message, password,
                    { hasher: CryptoJS.algo.SHA512 });
              } else {
                let kdf = OpenSSLPbkdf2;
                e = CryptoJS.lib.PasswordBasedCipher.decrypt(
                  CryptoJS.algo.AES, message, password,
                  { kdf: kdf, hasher: CryptoJS.algo.SHA512 });
              }
              let out;
              try {
                out = e.toString(CryptoJS.enc.Utf8);
              } catch(err) {
                console.error(err);
                out = e.toString(CryptoJS.enc.Latin1);
              }
              return out;
            }

            function rawme(l) {
              let blob = new Blob([document.getElementById('x').value], { type: "text/plain" });
              l.href = URL.createObjectURL(blob);
            }
        </script>

        <style>
            body {
                margin: 0;
                padding: 1em;
                padding-top: .5em;
                background: #eee;
            }
            #s {
              font-size: 120%;
              font-weight: bold;
              color: #777;
              height: 3ex;
              margin-left: .2em;
              vertical-align: bottom;
            }
            #x {
                width: 100%;
                border: 1px solid #ddd;
                border-radius: 10px;
                -webkit-box-sizing: border-box;
                -moz-box-sizing: border-box;
                box-sizing: border-box;
                margin-bottom: .5em;
                margin-top: .5em;
                padding: 1em;
                height: calc(100vh - 2em - 6ex);
                font-family:
                    Consolas,
                    Monaco,
                    Lucida Console,
                    Liberation Mono,
                    DejaVu Sans Mono,
                    Bitstream Vera Sans Mono,
                    Courier New,
                    monospace;
            }
            textarea:focus,
            textarea:active,
            textarea:disabled {
                background: white;
                color: black;
                border: 0;
                outline: none;
            }
            #command {
                display: none;
                position: absolute;
                float: left;
                bottom: 0;
                left: 0;
                padding-bottom: 0.25em;
            }
            #command input {
                border: 0;
                outline: none;
                font-family:
                    Consolas,
                    Monaco,
                    Lucida Console,
                    Liberation Mono,
                    DejaVu Sans Mono,
                    Bitstream Vera Sans Mono,
                    Couri er New,
                    monospace;
            }
            #controls {
                position: absolute;
                clear: both;
                bottom: 0;
                padding-bottom: 0.25em;
                right: 1em;
                color: #aaa;
            }
            i {
                color: #aaa;
            }
        </style>
    </head>
    <body>
        <noscript>
            This site requires JavaScript. However there is a command line
            client:
            <br />
            <pre>
    cd ~/bin
    curl -O https://raw.github.com/dgl/paste.sh/master/paste.sh
    chmod +x paste.sh
  </pre
            >
            Then use either:
            <pre>
    $ paste.sh some-file
  </pre
            >
            to upload text, or:
            <pre>
    $ paste.sh https://paste.sh/...
  </pre
            >
            to view text. See
            <a href="https://github.com/dgl/paste.sh">github</a> for more.
        </noscript>
        <div contenteditable id="s">📋🔐 paste.sh</div>
        <textarea
            id="x"
            placeholder="This is an encrypted paste site. Simply type or paste code here and share the URL"
        ></textarea>
        <div id="command"><input type="text" id="cmd" value=":" /></div>
        <div id="controls">
            <span id="status"></span> &nbsp;&nbsp;
            <a href="" oncontextmenu="rawme(this)" onclick="rawme(this)">raw</a>
            &bull; <a href="/">new</a> &bull; <a href="/about">about</a>
        </div>
    </body>
</html>
